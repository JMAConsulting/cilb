<?php

use Drupal\webform\Utility\WebformFormHelper;
use Drupal\Core\Url;
use Symfony\Component\HttpFoundation\RedirectResponse;
use Drupal\block\Entity\Block;
use Drupal\views\ViewExecutable;
use Drupal\views\Plugin\views\query\QueryPluginBase;

/**
 * Implements hook_form_alter().
 * @param $form
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 * @param $form_id
 */
function cilb_candidate_registration_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  if (
    $form_id == "webform_submission_register_english_add_form"
    || $form_id == "webform_submission_backoffice_registration_add_form"
  ) {
    // Attach library
    $form['#attached']['library'][] = 'cilb_candidate_registration/candidate_registration';
    $form['#attached']['library'][] = 'cilb_candidate_registration/exam_selection';
    $form['#attached']['library'][] = 'cilb_candidate_registration/selected_exam_info';

    if ($form_id == "webform_submission_register_english_add_form") {
      // Redirect to /register if notification block is disabled
      $elements = WebformFormHelper::flattenElements($form);
      $original_markup = $elements['user_identification_markup']['#markup'];

      if (!_is_block_active('bootstrap_barrio_subtheme_candidatenotice')) {
        $updated_markup = preg_replace(
          '/https:\/\/cilb\.jmaconsulting\.biz\/(es\/)?register-notification/',
          'https://cilb.jmaconsulting.biz/register',
          $original_markup
        );
        $elements['user_identification_markup']['#markup'] = $updated_markup;
      }
    }
  }
}

function cilb_candidate_registration_preprocess_page(&$variables) {
  $node = \Drupal::routeMatch()->getParameter('node');
  if ($node instanceof \Drupal\node\NodeInterface && $node->id() == 6) {
    $current_language = \Drupal::languageManager()->getCurrentLanguage()->getId();
    $block_id = 'bootstrap_barrio_subtheme_candidatenotice';

    // Redirect to webform if notification block is disabled
    if (!_is_block_active($block_id)) {
      if ($current_language == 'es') {
        $redirect_url = Url::fromUri('internal:/es/exam-registration');
      } else {
        $redirect_url = Url::fromUri('internal:/exam-registration');
      }
      $response = new RedirectResponse($redirect_url->toString());
      $response->send();
      exit();
    }
  }
}

function _is_block_active($block_id) {
  $block = Block::load($block_id);
  return $block && $block->status();
}

/**
 * Implements hook_views_query_alter().
 */
function cilb_candidate_registration_views_query_alter(ViewExecutable $view, QueryPluginBase $query) {
  if ($view->id() == 'exam_type' && $view->current_display == 'entity_reference_1') {

    // Check to make sure exams types are not full
    $events = \Civi\Api4\Event::get(FALSE)
      ->addSelect('option_value.id')
      ->addJoin('OptionValue AS option_value', 'LEFT', ['event_type_id', '=', 'option_value.value'])
      ->addWhere('is_active', '=', TRUE)
      //  ->addWhere('start_date', '>', 'now')
      //   ->addWhere('is_online_registration', '=', TRUE)
      ->addClause('OR', ['max_participants', 'IS NULL'], ['remaining_participants', '>', 0])
      ->addWhere('option_value.option_group_id', '=', 15)
      ->addGroupBy('event_type_id')
      ->addGroupBy('option_value.id')
      ->execute();

    $valid_option_ids = [];
    foreach ($events as $event) {
      $valid_option_ids[] = $event['option_value.id'];
    }

    if (!empty($valid_option_ids)) {
      $query->addWhere('AND', 'civicrm_option_value.id', $valid_option_ids, 'IN');
    } else {
      $query->addWhere('AND', 'civicrm_option_value.id', '0', '=');
    }
  } elseif ($view->id() == 'exams' && ($view->current_display == 'entity_reference_1' || $view->current_display == 'entity_reference_3')) {
    $submittedValues = $_POST;
    $selectedContact = $submittedValues['civicrm_1_contact_1_contact_existing'] ?? (
      (array_key_exists('civicrm_1_contact_1_contact_existing', $submittedValues) && empty($submittedValues['civicrm_1_contact_1_contact_existing'])) ? NULL : \CRM_Core_Session::getLoggedInContactID());
        
    // Check to make sure exams are not full
    $events = \Civi\Api4\Event::get(FALSE)
      ->addSelect('id', 'Exam_Details.Exam_Part', 'event_type_id', 'event_type_id:name', 'start_date')
      ->addWhere('is_active', '=', TRUE)
      //->addWhere('start_date', '>', 'now')
      //      ->addWhere('is_online_registration', '=', TRUE)
      ->addClause('OR', ['max_participants', 'IS NULL'], ['remaining_participants', '>', 0])
      ->execute();

    // check for existing registrations that mean we cant reregister for an exam
    //
    // NOTES:
    // - previous registrations where the result is FAIL or CANCELLED are excluded (need to be able to retake)
    // - previous registrations where the admin has set Bypass are excluded (this is used for cases
    //   where e.g. candidates need to retake after 3 years)
    // - the logic is different depending on whether the Exam Part is "Category Specific":
    //     category specific => only exclude registration is for the same part AND same category
    //     otherwise => exclude if registration for any exam for the same part, regardless of category
    //
    $categorySpecificExclusions = [];
    $generalExclusions = [];

    // only check if someone is logged in
    if (!empty($selectedContact)) {

      $examPartCategorySpecificity = \Civi\Api4\OptionValue::get(FALSE)
        ->addWhere('option_group_id:name', '=', 'Exam_Part')
        ->addSelect('value', 'Exam_Part_Options.Category_Specific')
        ->execute()
        ->indexBy('value')
        ->column('Exam_Part_Options.Category_Specific');

      $previousRegistrations = \Civi\Api4\Participant::get(FALSE)
        ->addSelect('event_id.Exam_Details.Exam_Part', 'event_id.event_type_id', 'event_id', 'status_id:name')
        ->addJoin('Event AS event', 'INNER', ['event.id', '=', 'event_id'])
        ->addWhere('contact_id', '=', $selectedContact)
        ->addWhere('status_id:name', 'NOT IN', ['Fail', 'Cancelled'])
        ->addWhere('Candidate_Result.Bypass_Reregistration_Check', 'IS EMPTY')
        ->execute()
        ->indexBy('event_id')
        ->getArrayCopy();

      foreach ($previousRegistrations as $previousReg) {
        // part = Trade Knowledge or Business & Finance or ...
        $previousRegPart = $previousReg['event_id.Exam_Details.Exam_Part'];

        if ($examPartCategorySpecificity[$previousRegPart]) {
          // initialise sub array for this part if not seen before
          $categorySpecificExclusions[$previousRegPart] ??= [];
          // sub-array of types, e.g. Air A, Air B
          $categorySpecificExclusions[$previousRegPart][] = $previousReg['event_id.event_type_id'];
        } else {
          $generalExclusions[] = $previousRegPart;
        }
      }
    }
    $valid_events = [];
    foreach ($events as $event) {
      $eventPart = $event['Exam_Details.Exam_Part'] ?? '';

      if (in_array($eventPart, $generalExclusions)) {
        // existing reg for this part, and its not category specific => skip
        continue;
      }

      $eventCategory = $event['event_type_id'];

      if (
        in_array($eventCategory, $categorySpecificExclusions[$eventPart] ?? [])
      ) {
        // we have an existing reg for the same part and category => skip
        continue;
      }

      if ($eventPart == 'TK' && $event['event_type_id:name'] == "Plumbing" && (date('Ymd', strtotime($event['start_date'])) < date('Ymd')) && $view->current_display == 'entity_reference_3') {
        // Only show future TK Plumbing exams
        continue;
      }

      // no matching previous => add to valid events
      $valid_events[] = $event['id'];
    }

    if (!empty($valid_events)) {
      $query->addWhere('AND', 'civicrm_event.id', $valid_events, 'IN');
    } else {
      $query->addWhere('AND', 'civicrm_event.id', '0', '=');
    }
  }
}
