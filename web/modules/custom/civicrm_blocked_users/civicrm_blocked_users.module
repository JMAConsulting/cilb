<?php

/**
 * @file
 * Main module file for CiviCRM Blocked Users sync.
 * 
 * REMOVED: hook_menu() - replaced with routing.yml + Form class
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function civicrm_blocked_users_help($route_name, RouteMatchInterface $route_match) {
    $output = '';
    if ($route_name == 'help.page.civicrm_blocked_users') {
        $output = '<p>Syncs Drupal blocked users and CiviCRM "Blocked Users" group bidirectionally.</p>';
    }
    return $output;
}

/**
 * Initial sync of existing blocked users.
 */
function civicrm_blocked_users_initial_sync() {
    $group_id = \Drupal::config('civicrm_blocked_users.settings')->get('group_id');

    if (!$group_id) {
        \Drupal::messenger()->addError(t('Blocked group not configured.'));
        return;
    }

    // Clear existing memberships
    \Civi\Api4\GroupContact::delete(FALSE)
        ->addWhere('group_id', '=', $group_id)
        ->execute();

    // Get all blocked Drupal users (status = 0)
    $blocked_users = \Drupal::entityTypeManager()
        ->getStorage('user')
        ->loadByProperties(['status' => 0]);

    $added = 0;
    foreach ($blocked_users as $user) {
        $uf_match = \Civi\Api4\UFMatch::get(FALSE)
            ->addSelect('contact_id')
            ->addWhere('uf_id', '=', $user->id())
            ->execute()
            ->first();

        if (!empty($uf_match['contact_id'])) {
            \Civi\Api4\GroupContact::create(FALSE)
                ->addValue('group_id', $group_id)
                ->addValue('contact_id', $uf_match['contact_id'])
                ->execute();
            $added++;
        }
    }

    \Drupal::logger('civicrm_blocked_users')->notice('@added users synced to blocked group.', ['@added' => $added]);
    \Drupal::messenger()->addMessage(t('Synced @added blocked users to CiviCRM group.', ['@added' => $added]));
}

/**
 * Implements hook_entity_presave().
 */
function civicrm_blocked_users_entity_presave(Drupal\Core\Entity\EntityInterface $entity){
    if ($entity->getEntityTypeId() !== 'user' || !$entity->isNew() && !$entity->original) {
        return;
    }

    \Drupal::service('civicrm')->initialize();
    $group_id = \Drupal::config('civicrm_blocked_users.settings')->get('group_id');
    if (!$group_id) {
        return;
    }

    $uid = $entity->id();
    if (!$uid) {
        return; // New user, no ID yet
    }

    $was_blocked = isset($entity->original) ? $entity->original->status : 1;
    $is_blocked = $entity->status->value;

    // Only act on status changes
    if ($was_blocked == $is_blocked) {
        return;
    }

    $uf_match = \Civi\Api4\UFMatch::get(FALSE)
        ->addSelect('contact_id')
        ->addWhere('uf_id', '=', $uid)
        ->execute()
        ->first();

    if (empty($uf_match['contact_id'])) {
        return;
    }

    $contact_id = $uf_match['contact_id'];

    if ($is_blocked == 0) {
        // Block user - Add to CiviCRM group
	    \Civi\Api4\GroupContact::save(FALSE)
		    ->addRecord([
		      'group_id' => $group_id,
		      'contact_id' => $contact_id
		    ])
		    ->setMatch(['group_id', 'contact_id'])
            ->execute();
    } else {
        // Unblock user - Remove from CiviCRM group
        \Civi\Api4\GroupContact::update(FALSE)
          ->addValue('status', 'Removed')
          ->addWhere('group_id', '=', $group_id)
          ->addWhere('contact_id', '=', $contact_id)
          ->execute();
    }
}

function civicrm_blocked_users_get_connected_user($group_id, $contactId) {
  // Find the GroupContact row for this contact + group.
  $group_contact = \Civi\Api4\GroupContact::get(FALSE)
    ->addWhere('group_id', '=', $group_id)
    ->addWhere('contact_id', '=', $contactId)
    ->execute()
    ->first();

  if (empty($group_contact) || $group_contact['group_id'] != $group_id) {
    return FALSE;
  }

  // Find Drupal user via UFMatch.
  $uf_match = \Civi\Api4\UFMatch::get(FALSE)
    ->addSelect('uf_id')
    ->addWhere('contact_id', '=', $contactId)
    ->execute()
    ->first();

  if (empty($uf_match['uf_id'])) {
    return FALSE;
  }

  $uid = $uf_match['uf_id'];
  $user = \Drupal\user\Entity\User::load($uid);
  if (!$user) {
    return FALSE;
  }

  return [$user, $group_contact];
}

/**
 * Implements hook_civicrm_pre().
 */
function civicrm_blocked_users_civicrm_pre($op, $objectName, $id, &$params) {
  // Only handle GroupContact operations.
  if ($objectName !== 'GroupContact') {
    return;
  }

  $group_id = \Drupal::config('civicrm_blocked_users.settings')->get('group_id');
  if (!$group_id) {
    return;
  }

  // For GroupContact delete, $params is an array of contact IDs being removed from the group.
  if ($op === 'delete' && !empty($params) && is_array($params)) {
    foreach ($params as $contactId) {
      $result = civicrm_blocked_users_get_connected_user($group_id, $contactId);
      if (!$result) {
        continue;
      }
      list($user, $group_contact) = $result;

      // Remove blocked status from Drupal user.
      if ($user->status->value == 0) { // Only unblock if currently blocked.
        $uid = $user->id();
        $user->set('status', 1);
        $user->save();
        \Drupal::logger('civicrm_blocked_users')->notice(
          'Unblocked Drupal user @uid due to CiviCRM group contact deletion.',
          ['@uid' => $uid]
        );
      }
    }
  }
}

/**
 * Implements hook_civicrm_custom().
 * Sync Registrant_Info.Is_Restricted ↔ Blocked Users group ↔ Drupal block status.
 */
function civicrm_blocked_users_civicrm_custom($op, $groupID, $entityID, &$params) {
  $group_id = \Drupal::config('civicrm_blocked_users.settings')->get('group_id');
  if (!$group_id || $groupID != 1) {
    return;
  }

  \Drupal::service('civicrm')->initialize();
  
  // Get contact ID from entityID
  $contact_id = $entityID;
  
  list($user, $group_contact) = civicrm_blocked_users_get_connected_user($group_id, $contact_id);

  $is_restricted = 0;
  foreach ($params as $param) {
    if (($param['custom_field_id'] ?? 0) == 23 ||
        ($param['column_name'] ?? '') == 'is_restricted__16') {
      $is_restricted = !empty($param['value']) ? 1 : 0;
      break;
    }
  }

  //$currently_blocked = ($group_contact['status'] == 'Added') ? 1 : 0;
  $currently_blocked = (isset($group_contact['status']) && $group_contact['status'] == 'Added') ? 1 : 0;


  if ($is_restricted && !$currently_blocked) {
    \Civi\Api4\GroupContact::save(FALSE)
      ->addRecord([
        'group_id' => $group_id,
	'contact_id' => $contact_id,
	'status' => 'Added'
      ])
      ->setMatch(['group_id', 'contact_id'])
      ->execute();
    
    if ($user->status->value == 1) {
      $user->set('status', 0);
      $user->save();
      \Drupal::logger('civicrm_blocked_users')->notice('Blocked @uid: Is_Restricted=TRUE', ['@uid' => $user->id()]);
    }
  } elseif (!$is_restricted && $currently_blocked) {
    \Civi\Api4\GroupContact::save(FALSE)
      ->addRecord([
        'group_id' => $group_id,
        'contact_id' => $contact_id,
        'status' => 'Removed'
      ])
      ->setMatch(['group_id', 'contact_id'])
      ->execute();

    if ($user->status->value == 0) {
      $user->set('status', 1);
      $user->save();
      \Drupal::logger('civicrm_blocked_users')->notice('Unblocked @uid: Is_Restricted=FALSE', ['@uid' => $user->id()]);
    }
  }
}


/**
 * Implements hook_civicrm_post().
 */
function civicrm_blocked_users_civicrm_post($op, $objectName, $objectId, &$objectRef) {
  // Only handle GroupContact operations (skip delete - handled in pre).
  if ($objectName !== 'GroupContact' || $op === 'delete') {
    return;
  }

  $group_id = \Drupal::config('civicrm_blocked_users.settings')->get('group_id');
  if (!$group_id) {
    return;
  }

  if (empty($objectRef) || !is_array($objectRef)) {
    return;
  }

  // For GroupContact create/edit, $objectRef is an array of contact IDs being added/updated.
  foreach ($objectRef as $contactId) {
    $result = civicrm_blocked_users_get_connected_user($group_id, $contactId);
    if (!$result) {
      continue;
    }
    list($user, $group_contact) = $result;

    // Handle membership changes.
    if (!empty($group_contact['status']) && $group_contact['status'] === 'Added') {
      // Added to blocked group – block Drupal user.
      if ($user->status->value == 1) { // Only block if currently active.
        $uid = $user->id();
        $user->set('status', 0);
        $user->save();
        \Drupal::logger('civicrm_blocked_users')->notice(
          'Blocked Drupal user @uid due to CiviCRM group addition.',
          ['@uid' => $uid]
        );
      }
    }
    elseif (!empty($group_contact['status']) && $group_contact['status'] === 'Removed') {
      // Removed from blocked group – unblock Drupal user.
      if ($user->status->value == 0) { // Only unblock if currently blocked.
        $uid = $user->id();
        $user->set('status', 1);
        $user->save();
        \Drupal::logger('civicrm_blocked_users')->notice(
          'Unblocked Drupal user @uid due to CiviCRM group removal.',
          ['@uid' => $uid]
        );
      }
    }
  }
}
